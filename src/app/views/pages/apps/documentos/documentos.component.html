<div class="container py-4">
  <div class="row">
    <div class="col-12">
      <main>
        <div class="card border-0 rounded-3 overflow-hidden shadow-sm">
          <!-- Encabezado de la tarjeta -->
          <div class="card-header bg-primary text-white py-3">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
              <div class="d-flex align-items-center gap-3">
                <h5 class="mb-0">
                  <i class="feather icon-file-text me-2"></i>
                  Control de Documentos
                </h5>
                <!-- Contador de registros -->
                <span class="badge bg-light text-primary fw-semibold">
                  {{ (documentos | filterByTerm: filtroTerm).length || 0 }} registros
                </span>
              </div>
              
              <!-- Botón subir documento -->
              <button class="btn btn-light text-primary fw-semibold shadow-sm" (click)="openModal(content)">
                <i class="feather icon-upload me-2"></i>
                Subir Documento
              </button>
            </div>
          </div>
          
          <!-- Barra de herramientas -->
          <div class="card-body border-bottom py-3 bg-light">
            <div class="row g-3 align-items-center">
              <!-- Buscador -->
              <div class="col-12 col-lg-6">
                <div class="input-group shadow-sm">
                  <span class="input-group-text bg-white border-end-0">
                    <i class="feather icon-search text-muted"></i>
                  </span>
                  <input
                    type="text"
                    class="form-control border-start-0 ps-0"
                    placeholder="Buscar por documento o propietario..."
                    [(ngModel)]="filtroTerm"
                    aria-label="Buscar documentos"
                  />
                  <button 
                    *ngIf="filtroTerm" 
                    class="btn btn-outline-secondary border-start-0" 
                    type="button"
                    (click)="filtroTerm = ''"
                    title="Limpiar búsqueda">
                    <i class="feather icon-x"></i>
                  </button>
                </div>
              </div>
              
              <!-- Filtros adicionales -->
              <div class="col-12 col-lg-6">
                <div class="d-flex gap-2 justify-content-lg-end flex-wrap">
                  <select class="form-select form-select-sm"  aria-label="Filtrar por estado" style="max-width: 200px;">
                    <option value="">Todos los estados</option>
                    <option value="vigente">Vigentes</option>
                    <option value="por-vencer">Por vencer</option>
                    <option value="vencido">Vencidos</option>
                  </select>
                  
                  <select class="form-select form-select-sm"  aria-label="Filtrar por tipo" style="max-width: 180px;">
                    <option value="">Todos los tipos</option>
                    <option value="chofer">Chofer</option>
                    <option value="vehiculo">Vehículo</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Tabla de datos -->
          <div class="table-responsive">
            <table class="table table-hover table-striped mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th scope="col" class="fw-semibold text-uppercase small">
                    <i class="feather icon-file me-1"></i>Documento
                  </th>
                  <th scope="col" class="fw-semibold text-uppercase small">
                    <i class="feather icon-user me-1"></i>Propietario
                  </th>
                  <th scope="col" class="fw-semibold text-uppercase small text-center">
                    <i class="feather icon-tag me-1"></i>Tipo
                  </th>
                  <th scope="col" class="fw-semibold text-uppercase small text-center">
                    <i class="feather icon-calendar me-1"></i>Fecha Exp.
                  </th>
                  <th scope="col" class="fw-semibold text-uppercase small text-center">
                    <i class="feather icon-activity me-1"></i>Estado
                  </th>
                  <th scope="col" class="fw-semibold text-uppercase small text-center">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let doc of documentos | filterByTerm: filtroTerm " class="documento-row">
                  <td class="fw-medium text-dark">
                    <i class="feather icon-file-text text-primary me-2"></i>
                    {{ doc.nombre }}
                  </td>
                  <td class="text-muted">
                    <i class="feather icon-user text-secondary me-2"></i>
                    {{ getNombrePropietario(doc) }}
                  </td>
                  <td class="text-center">
                    <span 
                      class="badge rounded-pill px-3 py-2" 
                      [ngClass]="doc.documentable_type.includes('Chofer') ? 'bg-info bg-opacity-10 text-info border border-info' : 'bg-purple bg-opacity-10 text-purple border border-purple'">
                      <i [class]="doc.documentable_type.includes('Chofer') ? 'feather icon-user' : 'feather icon-truck'" class="me-1"></i>
                      {{ doc.documentable_type.includes('Chofer') ? 'Chofer' : 'Vehículo' }}
                    </span>
                  </td>
                  <td class="text-muted">
                    <i class="feather icon-clock me-1"></i>
                    {{ doc.fecha_expiracion ? (doc.fecha_expiracion | date:'dd/MM/yyyy') : 'N/A' }}
                  </td>
                  <td class="text-center">
                    <span 
                      class=""
                      [ngClass]="getEstadoDocumento(doc.fecha_expiracion).clase">
                      <span class=""></span>
                      {{ getEstadoDocumento(doc.fecha_expiracion).estado }}
                    </span>
                  </td>
                  <td class="text-center">
                    <button 
                      class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm"
                      (click)="descargarArchivo(doc)" 
                      title="Descargar documento">
                      <i class="feather icon-download me-1"></i>
                      Descargar
                    </button>
                    
                  </td>
                </tr>
                
                <!-- Fila vacía -->
                <tr *ngIf="(documentos | filterByTerm: filtroTerm ).length === 0">
                  <td colspan="6" class="text-center py-5 text-muted">
                    <i class="feather icon-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mb-0 mt-3 fw-medium">No se encontraron documentos</p>
                    <p class="small text-muted">Intenta ajustar los filtros de búsqueda</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Footer -->
          <div class="card-footer bg-light border-top py-3">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <small class="text-muted">
                <i class="feather icon-info me-1"></i>
                Mostrando {{ (documentos | filterByTerm: filtroTerm ).length }} de {{ documentos?.length || 0 }} documentos
              </small>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>
</div>

<!-- Modal para subir documento -->
<ng-template #content let-modal>
  <div class="modal-header bg-primary text-white">
    <h4 class="modal-title mb-0" id="modal-basic-title">
      <i class="feather icon-upload me-2"></i>
      Cargar Documento de Cumplimiento
    </h4>
    <button type="button" class="btn-close btn-close-white" aria-label="Cerrar" (click)="modal.dismiss('Cross click')"></button>
  </div>
  
  <form (ngSubmit)="guardarDocumento()" #docForm="ngForm">
    <div class="modal-body p-4">
      
      <div class="mb-4">
        <label for="nombre" class="form-label fw-semibold">
          <i class="feather icon-file-text text-primary me-2"></i>
          Nombre del Documento <span class="text-danger">*</span>
        </label>
        <input 
          type="text" 
          id="nombre" 
          class="form-control" 
          [(ngModel)]="nuevoDocumento.nombre" 
          name="nombre" 
          required 
          placeholder="Ej: Póliza de Seguro">
      </div>

      <div class="mb-4">
        <label for="fechaExp" class="form-label fw-semibold">
          <i class="feather icon-calendar text-primary me-2"></i>
          Fecha de Expiración
        </label>
        <input 
          type="date" 
          id="fechaExp" 
          class="form-control" 
          [(ngModel)]="nuevoDocumento.fecha_expiracion" 
          name="fecha_expiracion">
      </div>

      <div class="row g-3 mb-4">
        
        <div class="col-md-6">
          <label for="docType" class="form-label fw-semibold">
            <i class="feather icon-tag text-primary me-2"></i>
            Aplica a <span class="text-danger">*</span>
          </label>
          <select 
            id="docType" 
            class="form-select" 
            [(ngModel)]="nuevoDocumento.documentable_type" 
            name="documentable_type" 
            required
            (change)="nuevoDocumento.documentable_id = null"> <option [ngValue]="''" disabled>-- Seleccionar tipo --</option>
            <option value="App\Models\Vehiculo">Vehículo</option>
            <option value="App\Models\Chofer">Chofer</option>
          </select>
        </div>
        
        <div class="col-md-6">
          <label for="docId" class="form-label fw-semibold">
            <i class="feather icon-user-check text-primary me-2"></i>
            Seleccionar Propietario <span class="text-danger">*</span>
          </label>
          
          <div *ngIf="isLoadingOwners" class="text-center p-2 border rounded">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Cargando...
          </div>

          <select 
            *ngIf="!isLoadingOwners"
            id="docId" 
            class="form-select" 
            [(ngModel)]="nuevoDocumento.documentable_id" 
            name="documentable_id" 
            required>

            <option [ngValue]="null" disabled>
              {{ nuevoDocumento.documentable_type ? '-- Selecciona --' : 'Selecciona Tipo Primero' }}
            </option>
            
            <ng-container *ngIf="nuevoDocumento.documentable_type === 'App\\Models\\Vehiculo'">
              <option *ngFor="let vehiculo of listaVehiculos" [ngValue]="vehiculo.vehiculo_id">
                {{ vehiculo.placa }} ({{ vehiculo.modelo?.modelo || 'N/A' }})
              </option>
            </ng-container>

            <ng-container *ngIf="nuevoDocumento.documentable_type === 'App\\Models\\Chofer'">
              <option *ngFor="let chofer of listaChoferes" [ngValue]="chofer.id">
                {{ chofer.usuario?.persona?.nombre_completo || 'Chofer sin nombre' }}
              </option>
            </ng-container>

          </select>
        </div>
      </div>
      
      <div class="mb-3">
        <label for="fileInput" class="form-label fw-semibold">
          <i class="feather icon-paperclip text-primary me-2"></i>
          Archivo (PDF, JPG, PNG) <span class="text-danger">*</span>
        </label>
        <input 
          type="file" 
          id="fileInput" 
          class="form-control" 
          (change)="onFileSelected($event)" 
          accept=".pdf,.jpg,.jpeg,.png"
          required>
        <div *ngIf="selectedFile" class="alert alert-success mt-3 d-flex align-items-center">
          <i class="feather icon-check-circle me-2"></i>
          <span>Archivo seleccionado: <strong>{{ selectedFile.name }}</strong></span>
        </div>
      </div>
    </div>
    
    <div class="modal-footer bg-light">
      <button type="button" class="btn btn-secondary" (click)="closeModal()">
        <i class="feather icon-x me-1"></i>
        Cancelar
      </button>
      <button 
        type="submit" 
        class="btn btn-success" 
        [disabled]="docForm.invalid || !selectedFile || nuevoDocumento.isUploading">
        <span *ngIf="!nuevoDocumento.isUploading">
          <i class="feather icon-upload me-1"></i>
          Subir y Guardar
        </span>
        <span *ngIf="nuevoDocumento.isUploading">
          <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          Cargando...
        </span>
      </button>
    </div>
  </form>
</ng-template>

<!-- Loading indicator -->
<div *ngIf="isLoading" class="loading-overlay">
  <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
    <span class="visually-hidden">Cargando...</span>
  </div>
  <p class="mt-3 text-muted fw-medium">Cargando documentos...</p>
</div>